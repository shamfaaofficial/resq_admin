<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>

<body class="dashboard-page">
  <% const formatRelative=(date)=> {
    const diff = Math.max(0, Math.floor((Date.now() - new Date(date).getTime()) / 1000));
    if (diff < 60) return `${diff}s ago`; if (diff < 3600) return `${Math.floor(diff / 60)}m ago`; if (diff < 86400)
      return `${Math.floor(diff / 3600)}h ago`; return `${Math.floor(diff / 86400)}d ago`; }; const
      formatNumber=(value)=> {
      const numeric = typeof value === "number" ? value : Number(value);
      return Number.isFinite(numeric) ? numeric.toLocaleString("en-US") : "—";
      };

      const formatCurrency = (value) => {
      const numeric = typeof value === "number" ? value : Number(value);
      return Number.isFinite(numeric)
      ? new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 2,
      }).format(numeric)
      : "—";
      };

      const formatPercent = (value) => {
      const numeric = typeof value === "number" ? value : Number(value);
      return Number.isFinite(numeric) ? `${numeric.toLocaleString("en-US")}%` : "—";
      };

      const safeNumber = (value, fallback = 0) => {
      const numeric = typeof value === "number" ? value : Number(value);
      return Number.isFinite(numeric) ? numeric : fallback;
      };

      const overview = stats?.overview || {};
      const timestampSnapshot = typeof timestamp !== "undefined" ? timestamp : null;
      const driverMetricsSummary = driversMetrics || {};
      const tripMetricsSummary = tripsMetrics || {};
      const revenueSummary = revenueMetrics || {};
      const usersMetricsSummary = usersMetrics || {};
      const pendingCount = Array.isArray(pendingDrivers) ? pendingDrivers.length : 0;

      const summaryCards = [
      {
      label: "Total trips",
      value: formatNumber(tripMetricsSummary.total),
      highlight: "Active trips",
      highlightValue: formatNumber(tripMetricsSummary.inProgress),
      },
      {
      label: "Revenue",
      value: formatCurrency(revenueSummary.total || overview.totalRevenue),
      highlight: "Today",
      highlightValue: formatCurrency(revenueSummary.today || overview.todayRevenue),
      },
      {
      label: "Drivers",
      value: formatNumber(driverMetricsSummary.total),
      highlight: "Online",
      highlightValue: formatNumber(driverMetricsSummary.online),
      },
      {
      label: "Pending approvals",
      value: formatNumber(pendingCount),
      highlight: "Documents",
      highlightValue: formatNumber(pendingCount),
      },
      ];

      const platformHealth = [
      {
      title: "Users",
      total: formatNumber(usersMetricsSummary.total),
      details: [
      { label: "Active today", value: formatNumber(usersMetricsSummary.activeToday) },
      { label: "New this month", value: formatNumber(usersMetricsSummary.newThisMonth) },
      { label: "Growth", value: formatPercent(usersMetricsSummary.growth) },
      ],
      },
      {
      title: "Drivers",
      total: formatNumber(driverMetricsSummary.total),
      details: [
      { label: "Online", value: formatNumber(driverMetricsSummary.online) },
      { label: "Available now", value: formatNumber(driverMetricsSummary.availableNow) },
      { label: "Pending", value: formatNumber(driverMetricsSummary.pending) },
      ],
      },
      {
      title: "Trips",
      total: formatNumber(tripMetricsSummary.total),
      details: [
      { label: "Today", value: formatNumber(tripMetricsSummary.today) },
      { label: "This week", value: formatNumber(tripMetricsSummary.thisWeek) },
      { label: "In progress", value: formatNumber(tripMetricsSummary.inProgress) },
      ],
      },
      {
      title: "Revenue",
      total: formatCurrency(revenueSummary.total || overview.totalRevenue),
      details: [
      { label: "Today", value: formatCurrency(revenueSummary.today || overview.todayRevenue) },
      { label: "Plat. commission", value: formatCurrency(revenueSummary.platformCommission) },
      { label: "Driver earnings", value: formatCurrency(revenueSummary.driverEarnings) },
      ],
      },
      ];
      %>

      <div class="dashboard-app">
        <%- include("partials/sidebar", { active: "dashboard" }) %>

          <main class="dashboard-main dashboard-main--simple" id="overview">
            <header class="dashboard-hero">
              <div>
                <p class="eyebrow">Admin console</p>
                <h1>Driver overview</h1>
              </div>
              <div class="header-actions">
                <span>Welcome, <%= user?.username || user?.phoneNumber || "Admin" %></span>
                <a href="/logout" class="button ghost">Log out</a>
              </div>
            </header>

            <% if (feedback && feedback.message) { %>
              <div class="alert alert-<%= feedback.type || 'info' %>" style="margin-bottom: 1.5rem;">
                <%= feedback.message %>
              </div>
              <% } %>

                <section class="summary-section">
                  <div class="stat-cards-grid">
                    <!-- Card 1: Total Trips (Blue) -->
                    <article class="stat-card stat-card--blue">
                      <div class="stat-card__header">
                        <div class="stat-card__info">
                          <p class="stat-card__value">
                            <%= formatNumber(tripMetricsSummary.total) %>
                          </p>
                          <p class="stat-card__label">Total Trips</p>
                        </div>
                        <div class="stat-card__icon">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 3h18v18H3z" />
                            <path d="M3 9h18M9 21V9" />
                          </svg>
                        </div>
                      </div>
                      <div class="stat-card__chart">
                        <svg viewBox="0 0 100 30" preserveAspectRatio="none">
                          <polyline points="0,25 20,20 40,22 60,15 80,18 100,10" fill="none"
                            stroke="rgba(255,255,255,0.4)" stroke-width="2" />
                        </svg>
                      </div>
                    </article>

                    <!-- Card 2: Active Trips (Cyan) -->
                    <article class="stat-card stat-card--cyan">
                      <div class="stat-card__header">
                        <div class="stat-card__info">
                          <p class="stat-card__value">
                            <%= formatNumber(tripMetricsSummary.inProgress) %>
                          </p>
                          <p class="stat-card__label">Active Trips</p>
                        </div>
                        <div class="stat-card__icon">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                          </svg>
                        </div>
                      </div>
                      <div class="stat-card__chart">
                        <svg viewBox="0 0 100 30" preserveAspectRatio="none">
                          <polyline points="0,20 20,18 40,15 60,20 80,12 100,8" fill="none"
                            stroke="rgba(255,255,255,0.4)" stroke-width="2" />
                        </svg>
                      </div>
                    </article>

                    <!-- Card 3: Revenue (Yellow) -->
                    <article class="stat-card stat-card--yellow">
                      <div class="stat-card__header">
                        <div class="stat-card__info">
                          <p class="stat-card__value">
                            <%= formatCurrency(revenueSummary.total || overview.totalRevenue) %>
                          </p>
                          <p class="stat-card__label">Total Revenue</p>
                        </div>
                        <div class="stat-card__icon">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23" />
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                          </svg>
                        </div>
                      </div>
                      <div class="stat-card__chart">
                        <svg viewBox="0 0 100 30" preserveAspectRatio="none">
                          <polyline points="0,28 20,24 40,20 60,18 80,14 100,12" fill="none" stroke="rgba(0,0,0,0.2)"
                            stroke-width="2" />
                        </svg>
                      </div>
                    </article>

                    <!-- Card 4: Online Drivers (Coral) -->
                    <article class="stat-card stat-card--coral">
                      <div class="stat-card__header">
                        <div class="stat-card__info">
                          <p class="stat-card__value">
                            <%= formatNumber(driverMetricsSummary.online) %>
                          </p>
                          <p class="stat-card__label">Drivers Online</p>
                        </div>
                        <div class="stat-card__icon">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                          </svg>
                        </div>
                      </div>
                      <div class="stat-card__chart">
                        <svg viewBox="0 0 100 30" preserveAspectRatio="none">
                          <rect x="5" y="20" width="8" height="10" fill="rgba(255,255,255,0.3)" />
                          <rect x="20" y="15" width="8" height="15" fill="rgba(255,255,255,0.3)" />
                          <rect x="35" y="18" width="8" height="12" fill="rgba(255,255,255,0.3)" />
                          <rect x="50" y="12" width="8" height="18" fill="rgba(255,255,255,0.3)" />
                          <rect x="65" y="16" width="8" height="14" fill="rgba(255,255,255,0.3)" />
                          <rect x="80" y="10" width="8" height="20" fill="rgba(255,255,255,0.3)" />
                        </svg>
                      </div>
                    </article>
                  </div>
                </section>

                <section class="platform-health-card">
                  <div class="platform-health-card__header">
                    <div>
                      <h2>Platform health</h2>
                      <p class="timestamp">
                        Data snapshot: <%= timestampSnapshot ? new Date(timestampSnapshot).toLocaleString() : "—" %>
                      </p>
                    </div>
                  </div>
                  <div class="platform-health-grid">
                    <% platformHealth.forEach((metric)=> { %>
                      <article class="platform-health-item">
                        <div class="platform-health-item__top">
                          <p class="platform-health-item__title">
                            <%= metric.title %>
                          </p>
                          <p class="platform-health-item__total">
                            <%= metric.total %>
                          </p>
                        </div>
                        <% metric.details.forEach((detail)=> { %>
                          <div class="platform-health-item__detail">
                            <span>
                              <%= detail.label %>
                            </span>
                            <strong>
                              <%= detail.value %>
                            </strong>
                          </div>
                          <% }); %>
                      </article>
                      <% }); %>
                  </div>
                </section>
          </main>
      </div>
</body>

</html>