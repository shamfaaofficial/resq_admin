<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="icon" type="image/png" href="/images/resq-logo.png">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>

<body class="dashboard-page">
  <% const formatRelative=(date)=> {
    const diff = Math.max(0, Math.floor((Date.now() - new Date(date).getTime()) / 1000));
    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  };

  const formatNumber=(value)=> {
    const numeric = typeof value === "number" ? value : Number(value);
    return Number.isFinite(numeric) ? numeric.toLocaleString("en-US") : "—";
  };

  const formatCurrency = (value) => {
    const numeric = typeof value === "number" ? value : Number(value);
    return Number.isFinite(numeric)
      ? new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 2,
        }).format(numeric)
      : "—";
  };

  const formatPercent = (value) => {
    const numeric = typeof value === "number" ? value : Number(value);
    return Number.isFinite(numeric) ? `${numeric.toLocaleString("en-US")}%` : "—";
  };

  const formatSignedPercent = (value) => {
    const numeric = typeof value === "number" ? value : Number(value);
    return Number.isFinite(numeric)
      ? `${numeric > 0 ? "+" : ""}${numeric.toLocaleString("en-US")}%`
      : "—";
  };

  const safeNumber = (value, fallback = 0) => {
    const numeric = typeof value === "number" ? value : Number(value);
    return Number.isFinite(numeric) ? numeric : fallback;
  };

  const deriveScore = (value) => {
    const numeric = safeNumber(value, 0);
    return numeric ? Math.max(8, Math.min(95, Math.round(Math.abs(numeric) % 100))) : 12;
  };

  const overview = stats?.overview || {};
  const timestampSnapshot = typeof timestamp !== "undefined" ? timestamp : null;
  const driverMetricsSummary = driversMetrics || {};
  const tripMetricsSummary = tripsMetrics || {};
  const revenueSummary = revenueMetrics || {};
  const usersMetricsSummary = usersMetrics || {};
  const pendingCount = Array.isArray(pendingDrivers) ? pendingDrivers.length : 0;

  const totalTripsValue = safeNumber(tripMetricsSummary.total, 0);
  const activeTripsValue = safeNumber(tripMetricsSummary.inProgress, 0);
  const completedTripsValue = safeNumber(
    tripMetricsSummary.completed,
    Math.max(totalTripsValue - activeTripsValue, 0)
  );
  const totalRevenueValue = safeNumber(revenueSummary.total || overview.totalRevenue, 0);
  const todayRevenueValue = safeNumber(revenueSummary.today || overview.todayRevenue, 0);
  const platformCommissionValue = safeNumber(revenueSummary.platformCommission, 0);
  const driverEarningsValue = safeNumber(revenueSummary.driverEarnings, 0);
  const usersGrowthValue = safeNumber(usersMetricsSummary.growth, 0);
  const driverGrowthValue = safeNumber(driverMetricsSummary.growth, 0);
  const companyValueChange = safeNumber(revenueSummary.growth, 0);
  const newAccountsValue = safeNumber(
    typeof usersMetricsSummary.newThisMonth === "number"
      ? usersMetricsSummary.newThisMonth
      : usersMetricsSummary.total,
    0
  );
  const activeUsersValue = safeNumber(usersMetricsSummary.activeToday, 0);
  const onlineDriversValue = safeNumber(driverMetricsSummary.online, 0);
  const newDriversRaw = safeNumber(driverMetricsSummary.newThisMonth, pendingCount);
  const driverTotalValue = safeNumber(driverMetricsSummary.total, 0);
  const verifiedDriversValue = Math.max(driverTotalValue - pendingCount, 0);
  const expenseBaseline = platformCommissionValue || driverEarningsValue || 0;
  const expenseChangeValue = expenseBaseline
    ? ((driverEarningsValue - platformCommissionValue) / Math.max(expenseBaseline, 1)) * 100
    : null;
  const spendPercent = totalRevenueValue > 0
    ? Math.min(100, Math.round(((driverEarningsValue || todayRevenueValue) / totalRevenueValue) * 100))
    : 0;

  const minimalCards = [
    {
      label: "New accounts",
      value: formatNumber(newAccountsValue),
      changeText: formatSignedPercent(usersGrowthValue),
      changeRaw: usersGrowthValue,
      badgeLabel: "Active today",
      badgeValue: formatNumber(activeUsersValue),
      badgeRaw: activeUsersValue,
      accent: "blue",
    },
    {
      label: "Total expenses",
      value: formatCurrency(driverEarningsValue),
      changeText: formatSignedPercent(expenseChangeValue ? -Math.abs(expenseChangeValue) : null),
      changeRaw: expenseChangeValue ? -Math.abs(expenseChangeValue) : null,
      badgeLabel: "Platform fees",
      badgeValue: formatCurrency(platformCommissionValue),
      badgeRaw: platformCommissionValue,
      accent: "pink",
    },
    {
      label: "Company value",
      value: formatCurrency(totalRevenueValue),
      changeText: formatSignedPercent(companyValueChange),
      changeRaw: companyValueChange,
      badgeLabel: "Today",
      badgeValue: formatCurrency(todayRevenueValue),
      badgeRaw: todayRevenueValue,
      accent: "amber",
    },
    {
      label: "New drivers",
      value: formatNumber(newDriversRaw),
      changeText: formatSignedPercent(driverGrowthValue),
      changeRaw: driverGrowthValue,
      badgeLabel: "Online now",
      badgeValue: formatNumber(onlineDriversValue),
      badgeRaw: onlineDriversValue,
      accent: "green",
    },
  ].map((card) => ({
    ...card,
    score: deriveScore(card.badgeRaw),
  }));

  const financialCards = [
    {
      label: "Income",
      value: formatCurrency(platformCommissionValue || todayRevenueValue),
      changeText: formatSignedPercent(companyValueChange),
      changeRaw: companyValueChange,
      helper: "vs last week",
    },
    {
      label: "Expenses",
      value: formatCurrency(driverEarningsValue),
      changeText: formatSignedPercent(expenseChangeValue ? -Math.abs(expenseChangeValue) : null),
      changeRaw: expenseChangeValue ? -Math.abs(expenseChangeValue) : null,
      helper: "Driver payouts",
    },
    {
      label: "Spendings",
      value: formatCurrency(driverEarningsValue - platformCommissionValue),
      changeText: formatSignedPercent(spendPercent),
      changeRaw: spendPercent,
      helper: "Budget used",
    },
    {
      label: "Totals",
      value: formatCurrency(totalRevenueValue),
      changeText: formatSignedPercent(companyValueChange),
      changeRaw: companyValueChange,
      helper: "Lifetime revenue",
    },
  ];

  const targetMetrics = [
    {
      label: "Trip completion",
      percent: totalTripsValue > 0
        ? Math.min(100, Math.round((completedTripsValue / Math.max(totalTripsValue, 1)) * 100))
        : 0,
      detail: `${formatNumber(completedTripsValue)} completed`
    },
    {
      label: "Document approvals",
      percent: driverTotalValue > 0
        ? Math.min(100, Math.round((verifiedDriversValue / Math.max(driverTotalValue, 1)) * 100))
        : 0,
      detail: `${formatNumber(verifiedDriversValue)} verified`
    }
  ];

  const trafficDays = ["Jan 05", "Jan 06", "Jan 07", "Jan 08", "Jan 09", "Jan 10", "Jan 11"];
  const baseTrips = totalTripsValue || 700;
  const baseActiveTrips = activeTripsValue || 140;
  const trafficSeries = trafficDays.map((label, index) => {
    const websiteBlog = Math.round(baseTrips / trafficDays.length + index * 30);
    const socialMedia = Math.round(baseActiveTrips / trafficDays.length + index * 6);
    return { label, websiteBlog, socialMedia };
  });
  const trafficMaxVolume = trafficSeries.reduce((max, point) => Math.max(max, point.websiteBlog, point.socialMedia), 0) || 100;
  const trafficLineMax = trafficSeries.reduce((max, point) => Math.max(max, point.socialMedia), 0) || 100;
  const trafficLinePoints = trafficSeries.map((point, index) => {
    const divisor = Math.max(trafficSeries.length - 1, 1);
    const x = (index / divisor) * 100;
    const y = 55 - ((point.socialMedia / trafficLineMax) * 45);
    return `${x},${y}`;
  }).join(" ");

  const platformHealth = [
    {
      title: "Users",
      total: formatNumber(usersMetricsSummary.total),
      details: [
        { label: "Active today", value: formatNumber(usersMetricsSummary.activeToday) },
        { label: "New this month", value: formatNumber(usersMetricsSummary.newThisMonth) },
        { label: "Growth", value: formatPercent(usersMetricsSummary.growth) },
      ],
    },
    {
      title: "Drivers",
      total: formatNumber(driverMetricsSummary.total),
      details: [
        { label: "Online", value: formatNumber(driverMetricsSummary.online) },
        { label: "Available now", value: formatNumber(driverMetricsSummary.availableNow) },
        { label: "Pending", value: formatNumber(driverMetricsSummary.pending) },
      ],
    },
    {
      title: "Trips",
      total: formatNumber(tripMetricsSummary.total),
      details: [
        { label: "Today", value: formatNumber(tripMetricsSummary.today) },
        { label: "This week", value: formatNumber(tripMetricsSummary.thisWeek) },
        { label: "In progress", value: formatNumber(tripMetricsSummary.inProgress) },
      ],
    },
    {
      title: "Revenue",
      total: formatCurrency(revenueSummary.total || overview.totalRevenue),
      details: [
        { label: "Today", value: formatCurrency(revenueSummary.today || overview.todayRevenue) },
        { label: "Plat. commission", value: formatCurrency(revenueSummary.platformCommission) },
        { label: "Driver earnings", value: formatCurrency(revenueSummary.driverEarnings) },
      ],
    },
  ];
  %>

  <div class="dashboard-app dashboard-app--minimal">
    <%- include("partials/sidebar", { active: "dashboard" }) %>

    <main class="dashboard-main dashboard-main--minimal" id="overview">
      <%- include("partials/mobile-nav", { title: "Dashboard", user }) %>

      <!-- <section class="dashboard-hero-banner">
        <div class="dashboard-hero-glow"></div>
        <div class="dashboard-hero-content">
          <span class="dashboard-hero-pill">Live overview</span>
          <h1>
            Hi <%= user?.username || user?.phoneNumber || "Admin" %>,
            keep the platform humming.
          </h1>
          <p>
            <strong><%= formatNumber(activeTripsValue) %></strong> trips are currently active and
            <strong><%= formatNumber(pendingCount) %></strong> drivers await document approvals.
          </p>
          <div class="dashboard-hero-actions">
            <a href="/document-approvals" class="button hero-primary">Review documents</a>
            <a href="/drivers" class="button hero-ghost">View driver list</a>
          </div>
        </div>
        <div class="dashboard-hero-stats">
          <article>
            <p>Total Trips</p>
            <strong><%= formatNumber(totalTripsValue) %></strong>
            <small>+<%= formatNumber(activeTripsValue) %> live</small>
          </article>
          <article>
            <p>Revenue Today</p>
            <strong><%= formatCurrency(todayRevenueValue) %></strong>
            <small><%= formatSignedPercent(companyValueChange) %> vs last week</small>
          </article>
          <article>
            <p>Drivers Online</p>
            <strong><%= formatNumber(onlineDriversValue) %></strong>
            <small><%= formatNumber(newDriversRaw) %> new this month</small>
          </article>
        </div>
      </section> -->

      <section class="page-header">
        <div>
          <p class="breadcrumbs">Dashboard</p>
          <h1>  Dashboard</h1>
          <!-- <p class="page-subtitle">This dashboard example was created using the available components in the system.</p> -->
        </div>
        <div class="header-actions">
          <a href="/logout" class="button ghost">Log out</a>
        </div>
      </section>

      <% if (feedback && feedback.message) { %>
        <div class="alert alert-<%= feedback.type || 'info' %>" style="margin-bottom: 1.5rem;">
          <%= feedback.message %>
        </div>
      <% } %>

      <section class="announcement-card">
        <p>This dashboard uses only built-in UI blocks. Feel free to mix and match the components to build your next board.</p>
        <span class="timestamp">SYNC:<%= timestampSnapshot ? new Date(timestampSnapshot).toLocaleString() : "—" %></span>
      </section>

      <section class="minimal-stat-grid">
        <% minimalCards.forEach((card)=> { %>
          <article class="minimal-card minimal-card--<%= card.accent %>">
            <div>
              <p class="card-label"><%= card.label %></p>
              <p class="card-value"><%= card.value %></p>
              <p class="card-meta">
                <% const cardTrend = Number.isFinite(card.changeRaw) ? (card.changeRaw >= 0 ? 'trend--up' : 'trend--down') : 'trend--neutral'; %>
                <span class="trend <%= cardTrend %>"><%= card.changeText %></span>
                <span class="card-hint"><%= card.badgeLabel %></span>
              </p>
            </div>
            <div class="card-side">
              <div class="progress-circle" style="--score: <%= card.score %>">
                <span><%= card.score %></span>
              </div>
              <p class="progress-label"><%= card.badgeValue %></p>
            </div>
          </article>
        <% }) %>
      </section>

      <!-- <section class="minimal-main-grid">
        <article class="panel panel-traffic">
          <div class="panel-header">
            <div>
              <h2>Traffic sources</h2>
              <p>Website blog vs Social media performance</p>
            </div>
            <button class="panel-action" type="button">Actions</button>
          </div>
          <div class="traffic-chart">
            <svg viewBox="0 0 100 60" preserveAspectRatio="none">
              <% trafficSeries.forEach((point, index)=> { const barWidth = 8; const gap = 100 / trafficSeries.length; const x = index * gap + (gap - barWidth) / 2; const barHeight = (point.websiteBlog / trafficMaxVolume) * 45; const barY = 55 - barHeight; %>
                <rect x="<%= x %>" y="<%= barY %>" width="<%= barWidth %>" height="<%= Math.max(barHeight, 1) %>" rx="2"></rect>
              <% }) %>
              <polyline points="<%= trafficLinePoints %>" fill="none" stroke="#4CAF50" stroke-width="1.5" stroke-linecap="round"></polyline>
              <% trafficSeries.forEach((point, index)=> { const divisor = Math.max(trafficSeries.length - 1, 1); const cx = (index / divisor) * 100; const cy = 55 - ((point.socialMedia / trafficLineMax) * 45); %>
                <circle cx="<%= cx %>" cy="<%= cy %>" r="1.6" fill="#fff" stroke="#4CAF50" stroke-width="0.8"></circle>
              <% }) %>
            </svg>
            <div class="traffic-chart__labels">
              <% trafficSeries.forEach((point)=> { %>
                <span><%= point.label %></span>
              <% }) %>
            </div>
          </div>
          <div class="traffic-legend">
            <div>
              <span class="legend-dot legend-dot--blue"></span>
              Website Blog
            </div>
            <div>
              <span class="legend-dot legend-dot--green"></span>
              Social Media
            </div>
          </div>
        </article>

        <article class="panel panel-income">
          <div class="panel-header">
            <div>
              <h2>Income</h2>
              <p>Spending target overview</p>
            </div>
          </div>
          <div class="income-content">
            <div class="progress-ring" style="--progress: <%= spendPercent %>">
              <div class="progress-ring__inner">
                <p>Percent</p>
                <strong><%= spendPercent %>%</strong>
              </div>
            </div>
            <div class="income-details">
              <p class="target-value">Target: <strong><%= formatCurrency(totalRevenueValue) %></strong></p>
              <ul class="income-list">
                <li>
                  <span>Platform commission</span>
                  <strong><%= formatCurrency(platformCommissionValue) %></strong>
                </li>
                <li>
                  <span>Driver earnings</span>
                  <strong><%= formatCurrency(driverEarningsValue) %></strong>
                </li>
                <li>
                  <span>Revenue today</span>
                  <strong><%= formatCurrency(todayRevenueValue) %></strong>
                </li>
              </ul>
            </div>
          </div>
        </article>
      </section> -->

      <!-- <section class="financial-grid">
        <% financialCards.forEach((card)=> { %>
          <article class="financial-card">
            <div class="financial-card__label-row">
              <p><%= card.label %></p>
              <% const panelTrend = Number.isFinite(card.changeRaw) ? (card.changeRaw >= 0 ? 'trend--up' : 'trend--down') : 'trend--neutral'; %>
              <span class="trend <%= panelTrend %>"><%= card.changeText %></span>
            </div>
            <p class="financial-card__value"><%= card.value %></p>
            <p class="financial-card__hint"><%= card.helper %></p>
          </article>
        <% }) %>
      </section> -->

      <!-- <section class="target-section">
        <header>
          <h2>Target section</h2>
          <p>Monitor the completion of core operational goals</p>
        </header>
        <div class="target-grid">
          <% targetMetrics.forEach((metric)=> { %>
            <article class="target-card">
              <div class="target-card__top">
                <p class="target-label"><%= metric.label %></p>
                <span><%= metric.percent %>%</span>
              </div>
              <div class="target-progress">
                <div class="target-progress__bar" style="width: <%= metric.percent %>%"></div>
              </div>
              <p class="target-detail"><%= metric.detail %></p>
            </article>
          <% }) %>
        </div>
      </section> -->

      <section class="platform-health-card platform-health-card--minimal">
        <div class="platform-health-card__header">
          <div>
            <h2>Platform health</h2>
            <p class="timestamp">Updated <%= formatRelative(timestampSnapshot || Date.now()) %></p>
          </div>
        </div>
        <div class="platform-health-grid">
          <% platformHealth.forEach((metric)=> { %>
            <article class="platform-health-item">
              <div class="platform-health-item__top">
                <p class="platform-health-item__title"><%= metric.title %></p>
                <p class="platform-health-item__total"><%= metric.total %></p>
              </div>
              <% metric.details.forEach((detail)=> { %>
                <div class="platform-health-item__detail">
                  <span><%= detail.label %></span>
                  <strong><%= detail.value %></strong>
                </div>
              <% }) %>
            </article>
          <% }) %>
        </div>
      </section>
    </main>
  </div>
  <script src="/js/dashboard.js"></script>
</body>

</html>
