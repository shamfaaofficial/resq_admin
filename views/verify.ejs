<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify OTP</title>
  <link rel="icon" type="image/png" href="/images/resq-logo.png">
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body class="auth-page">
  <main class="verify-container">
    <div class="verify-card">
      <header class="verify-header">
        <h1>Mobile Phone Verification</h1>
        <p class="subhead">
          Enter the 6-digit verification code that was sent to your phone number.
        </p>
      </header>

      <% if (status) { %>
        <p class="message <%= status.type %>">
          <%= status.message %>
        </p>
        <% } %>

          <form action="/verify-otp" method="post" class="verify-form" novalidate>
            <input type="hidden" name="phoneNumber" value="<%= phoneNumber %>" />

            <div class="pin-board">
              <div class="pin-inputs" role="group" aria-label="OTP digits">
                <% for (let index=0; index < 6; index++) { %>
                  <input type="tel" inputmode="numeric" pattern="\d" maxlength="1" class="pin-digit"
                    aria-label="Digit <%= index + 1 %>" />
                  <% } %>
              </div>
              <input type="hidden" name="otp" id="otpValue" required />
            </div>

            <button type="submit" class="button primary full-width">Verify Account</button>
          </form>

          <div class="verify-footer">
            <p>Didn't receive code?
            <form action="/resend-otp" method="POST" style="display: inline;">
              <input type="hidden" name="phoneNumber" value="<%= phoneNumber %>" />
              <button type="submit" class="link-text"
                style="background: none; border: none; cursor: pointer; padding: 0; text-decoration: underline;">Resend</button>
            </form>
            </p>
          </div>
    </div>
  </main>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector(".login-form");
      const inputs = Array.from(document.querySelectorAll(".pin-digit"));
      const otpValue = document.getElementById("otpValue");

      const joinDigits = () => inputs.map((input) => input.value.trim()).join("");

      inputs.forEach((input, idx) => {
        input.addEventListener("input", (event) => {
          const digit = event.target.value.replace(/\\D/g, "");
          event.target.value = digit.slice(-1);

          if (digit && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }

          otpValue.value = joinDigits();
        });

        input.addEventListener("keydown", (event) => {
          if (event.key === "Backspace" && !input.value && idx > 0) {
            inputs[idx - 1].focus();
          }
        });
      });

      inputs[0]?.focus();

      form?.addEventListener("submit", () => {
        otpValue.value = joinDigits();
      });
    });
  </script>
</body>

</html>