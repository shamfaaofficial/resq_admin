<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Users - Admin Panel</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/users.css" />
</head>

<body class="dashboard-page">
    <div class="dashboard-app">
        <%- include("partials/sidebar", { active: "users" }) %>

            <main class="dashboard-main">
                <%- include("partials/mobile-nav", { title: "Users", user }) %>

                <header class="dashboard-hero">
                    <div>
                        <p class="eyebrow">User Management</p>
                        <h1>All Users</h1>
                    </div>
                    <div class="header-actions">
                        <span>Welcome, <%= user?.username || user?.phoneNumber || "Admin" %></span>
                        <a href="/logout" class="button ghost">Log out</a>
                    </div>
                </header>

                <% if (message) { %>
                    <div class="alert alert-<%= type || 'info' %>"
                        style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 12px; background: <%= type === 'success' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)' %>; color: <%= type === 'success' ? '#16a34a' : '#dc2626' %>;">
                        <%= message %>
                    </div>
                    <% } %>

                        <!-- Filter Bar -->
                        <div class="filter-bar">
                            <form method="GET" action="/users" class="filter-bar-top">
                                <div class="search-box">
                                    <input type="text" name="search" placeholder="Search by User Name / Phone / Email"
                                        value="<%= search || '' %>" />
                                </div>

                                <div class="filter-group">
                                    <select name="status" class="filter-select">
                                        <option value="">All Status</option>
                                        <option value="active" <%=status==='active' ? 'selected' : '' %>>Active</option>
                                        <option value="inactive" <%=status==='inactive' ? 'selected' : '' %>>Inactive
                                        </option>
                                        <option value="blocked" <%=status==='blocked' ? 'selected' : '' %>>Blocked
                                        </option>
                                    </select>

                                    <button type="submit" class="button" style="padding: 0.75rem 1.25rem;">Apply
                                        Filters</button>
                                    <a href="/users" class="button ghost" style="padding: 0.75rem 1.25rem;">Clear</a>
                                </div>

                                <button type="button" class="btn-add-user"
                                    onclick="alert('Add User feature coming soon!')">
                                    <span>‚ûï</span>
                                    <span>Add User</span>
                                </button>
                            </form>
                        </div>

                        <!-- User Table -->
                        <div class="user-table-wrapper">
                            <% if (users && users.length> 0) { %>
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAll" />
                                            </th>
                                            <th>User ID</th>
                                            <th>User Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Total Trips</th>
                                            <th>Status</th>
                                            <th>Joined Date</th>
                                            <th style="text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% users.forEach((userItem)=> {
                                            const userId = userItem._id || userItem.id || 'N/A';
                                            const userName = userItem.name || userItem.fullName || 'Unknown';
                                            const phone = userItem.phoneNumber || userItem.phone || 'N/A';
                                            const email = userItem.email || 'N/A';
                                            const totalTrips = userItem.totalTrips || 0;
                                            const userStatus = userItem.status || 'active';
                                            const joinedDate = userItem.createdAt || userItem.joinedAt;
                                            const isBlocked = userItem.isBlocked || userItem.blocked || false;

                                            let statusClass = 'status-badge-active';
                                            let statusText = 'Active';

                                            if (isBlocked || userStatus === 'blocked') {
                                            statusClass = 'status-badge-blocked';
                                            statusText = 'Blocked';
                                            } else if (userStatus === 'inactive') {
                                            statusClass = 'status-badge-inactive';
                                            statusText = 'Inactive';
                                            }

                                            const formatDate = (date) => {
                                            if (!date) return 'N/A';
                                            const d = new Date(date);
                                            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year:
                                            'numeric' });
                                            };
                                            %>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" name="userSelect" value="<%= userId %>" />
                                                </td>
                                                <td style="font-family: monospace; font-size: 0.85rem; color: #6b7280;">
                                                    <%= userId.substring(0, 8) %>...
                                                </td>
                                                <td style="font-weight: 500;">
                                                    <%= userName %>
                                                </td>
                                                <td>
                                                    <%= phone %>
                                                </td>
                                                <td>
                                                    <%= email %>
                                                </td>
                                                <td>
                                                    <%= totalTrips %>
                                                </td>
                                                <td>
                                                    <span class="status-badge <%= statusClass %>">
                                                        <%= statusText %>
                                                    </span>
                                                </td>
                                                <td style="color: #6b7280; font-size: 0.85rem;">
                                                    <%= formatDate(joinedDate) %>
                                                </td>
                                                <td>
                                                    <div class="action-buttons" style="justify-content: center;">
                                                        <button class="action-btn action-btn-view" title="View Details"
                                                            onclick="viewUser('<%= userId %>')">
                                                            üëÅÔ∏è
                                                        </button>
                                                        <button class="action-btn action-btn-edit" title="Edit User"
                                                            onclick="alert('Edit feature coming soon!')">
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <div style="position: relative; display: inline-block;">
                                                            <button type="button" class="action-btn action-btn-delete"
                                                                title="Delete User"
                                                                onclick="toggleDeleteMenu('<%= userId %>')">
                                                                üóëÔ∏è
                                                            </button>
                                                            <div id="delete-menu-<%= userId %>" class="delete-dropdown"
                                                                style="display: none;">
                                                                <form
                                                                    action="/users/<%= userId %>/delete?hardDelete=false"
                                                                    method="POST"
                                                                    onsubmit="return confirm('Are you sure you want to delete this user? This is a soft delete and can be recovered.');">
                                                                    <button type="submit" class="delete-option">
                                                                        üóëÔ∏è Delete (Soft)
                                                                    </button>
                                                                </form>
                                                                <form
                                                                    action="/users/<%= userId %>/delete?hardDelete=true"
                                                                    method="POST"
                                                                    onsubmit="return confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete this user and ALL associated data. This action CANNOT be undone. Are you absolutely sure?');">
                                                                    <button type="submit" class="delete-option danger">
                                                                        ‚ö†Ô∏è Delete (Permanent)
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                        <button class="action-btn action-btn-block"
                                                            title="<%= isBlocked ? 'Unblock' : 'Block' %> User"
                                                            onclick="alert('Block/Unblock feature coming soon!')">
                                                            <%= isBlocked ? 'üîì' : 'üîí' %>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>

                                <!-- Pagination -->
                                <% if (pagination && pagination.totalPages> 1) { %>
                                    <div class="pagination">
                                        <% if (pagination.currentPage> 1) { %>
                                            <a href="?page=<%= pagination.currentPage - 1 %>&status=<%= status || '' %>&search=<%= search || '' %>"
                                                class="pagination-btn">
                                                ‚Üê Previous
                                            </a>
                                            <% } else { %>
                                                <button class="pagination-btn" disabled>‚Üê Previous</button>
                                                <% } %>

                                                    <span class="pagination-info">
                                                        Page <%= pagination.currentPage %> of <%= pagination.totalPages
                                                                %>
                                                                (<%= pagination.totalUsers || totalUsers || 0 %> total)
                                                    </span>

                                                    <% if (pagination.currentPage < pagination.totalPages) { %>
                                                        <a href="?page=<%= pagination.currentPage + 1 %>&status=<%= status || '' %>&search=<%= search || '' %>"
                                                            class="pagination-btn">
                                                            Next ‚Üí
                                                        </a>
                                                        <% } else { %>
                                                            <button class="pagination-btn" disabled>Next ‚Üí</button>
                                                            <% } %>
                                    </div>
                                    <% } %>
                                        <% } else { %>
                                            <!-- Empty State -->
                                            <div class="empty-state">
                                                <div class="empty-state-icon">üë•</div>
                                                <h3>No users found</h3>
                                                <p>
                                                    <% if (search || status) { %>
                                                        Try adjusting your filters or search query.
                                                        <% } else { %>
                                                            Start by adding your first user to the system.
                                                            <% } %>
                                                </p>
                                            </div>
                                            <% } %>
                        </div>
            </main>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        // Select all checkbox functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        const userCheckboxes = document.querySelectorAll('input[name="userSelect"]');

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }

        // View user function
        function viewUser(userId) {
            // TODO: Implement user detail view
            alert('User details view - ID: ' + userId);
        }

        // Delete dropdown functionality
        function toggleDeleteMenu(userId) {
            console.log('üîç Toggle delete menu for user:', userId);
            const menu = document.getElementById('delete-menu-' + userId);

            if (!menu) {
                console.error('‚ùå Menu not found for user:', userId);
                return;
            }

            const isVisible = menu.style.display === 'block';
            console.log('Menu current state:', isVisible ? 'visible' : 'hidden');

            // Close all other menus
            document.querySelectorAll('.delete-dropdown').forEach(m => {
                m.style.display = 'none';
            });

            // Toggle current menu
            menu.style.display = isVisible ? 'none' : 'block';
            console.log('Menu new state:', menu.style.display);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.delete-dropdown') && !event.target.closest('.action-btn-delete')) {
                console.log('üîç Clicking outside, closing all menus');
                document.querySelectorAll('.delete-dropdown').forEach(m => {
                    m.style.display = 'none';
                });
            }
        });

        // Log when forms are submitted
        document.addEventListener('submit', function (event) {
            if (event.target.action && event.target.action.includes('/delete')) {
                console.log('üóëÔ∏è Delete form submitting:', event.target.action);
            }
        });
    </script>
</body>

</html>
