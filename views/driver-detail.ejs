<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
        <%= driver?.name || 'Driver Details' %> - Admin Panel
    </title>
    <link rel="icon" type="image/png" href="/images/resq-logo.png">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/drivers.css" />
</head>

<body class="dashboard-page">
    <div class="dashboard-app">
        <%- include("partials/sidebar", { active: "drivers" }) %>

            <main class="dashboard-main">
                <%- include("partials/mobile-nav", { title: "Driver detail", user }) %>

                <header class="dashboard-hero">
                    <div>
                        <p class="eyebrow">Driver Management</p>
                        <h1>Driver Details</h1>
                    </div>
                    <div class="header-actions">
                        <a href="/drivers" class="button ghost">‚Üê Back to Drivers</a>
                        <a href="/logout" class="button ghost">Log out</a>
                    </div>
                </header>

                <% if (message) { %>
                    <div class="alert alert-<%= type || 'info' %>"
                        style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 12px; background: <%= type === 'success' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)' %>; color: <%= type === 'success' ? '#16a34a' : '#dc2626' %>;">
                        <%= message %>
                    </div>
                    <% } %>

                        <% if (driver) { const driverId=driver._id || driver.id; const driverName=driver.name ||
                            driver.fullName || 'Unknown Driver' ; const phone=driver.phoneNumber || driver.phone
                            || 'N/A' ; const email=driver.email || 'N/A' ; const joiningDate=driver.createdAt ||
                            driver.joinedAt; const approvalStatus=driver.approvalStatus || driver.status || 'pending' ;
                            const isBlocked=driver.isBlocked || driver.blocked || false; const
                            vehicleNumber=driver.vehicleNumber || driver.vehicle?.number || 'N/A' ; const
                            vehicleType=driver.vehicleType || driver.vehicle?.type || 'N/A' ; const rating=driver.rating
                            || driver.averageRating || 0; const totalTrips=driver.totalTrips || driver.tripsCount || 0;
                            const documents=driver.documents || []; let statusClass='status-badge-pending' ; let
                            statusText='Pending' ; if (isBlocked) { statusClass='status-badge-blocked' ;
                            statusText='Blocked' ; } else if (approvalStatus==='approved' || approvalStatus==='active' )
                            { statusClass='status-badge-approved' ; statusText='Approved' ; } else if
                            (approvalStatus==='rejected' ) { statusClass='status-badge-rejected' ; statusText='Rejected'
                            ; } const formatDate=(date)=> {
                            if (!date) return 'N/A';
                            const d = new Date(date);
                            return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                            };

                            const getInitials = (name) => {
                            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                            };
                            %>

                            <div class="driver-detail-container">
                                <!-- Basic Info Card -->
                                <div class="driver-info-card">
                                    <div class="driver-header">
                                        <% if (driver.profilePhoto || driver.avatar) { %>
                                            <img src="<%= driver.profilePhoto || driver.avatar %>"
                                                alt="<%= driverName %>" class="driver-avatar" />
                                            <% } else { %>
                                                <div class="driver-avatar-placeholder">
                                                    <%= getInitials(driverName) %>
                                                </div>
                                                <% } %>

                                                    <div class="driver-header-info">
                                                        <h1>
                                                            <%= driverName %>
                                                        </h1>
                                                        <p style="font-size: 1rem; color: #111827; margin-top: 0.5rem;">
                                                            <span class="status-badge <%= statusClass %>">
                                                                <%= statusText %>
                                                            </span>
                                                        </p>
                                                        <p><strong>Driver ID:</strong>
                                                            <%= driverId %>
                                                        </p>
                                                        <p><strong>Phone:</strong>
                                                            <%= phone %>
                                                        </p>
                                                        <% if (email !=='N/A' ) { %>
                                                            <p><strong>Email:</strong>
                                                                <%= email %>
                                                            </p>
                                                            <% } %>
                                                    </div>
                                    </div>

                                    <div class="driver-info-grid">
                                        <div class="info-item">
                                            <span class="info-label">Joining Date</span>
                                            <span class="info-value">
                                                <%= formatDate(joiningDate) %>
                                            </span>
                                        </div>

                                        <div class="info-item">
                                            <span class="info-label">Vehicle Number</span>
                                            <span class="info-value">
                                                <%= vehicleNumber %>
                                            </span>
                                        </div>

                                        <div class="info-item">
                                            <span class="info-label">Vehicle Type</span>
                                            <span class="info-value">
                                                <%= vehicleType %>
                                            </span>
                                        </div>

                                        <div class="info-item">
                                            <span class="info-label">Rating</span>
                                            <span class="info-value">‚≠ê <%= rating.toFixed(1) %> / 5.0</span>
                                        </div>

                                        <div class="info-item">
                                            <span class="info-label">Total Trips</span>
                                            <span class="info-value">
                                                <%= totalTrips %>
                                            </span>
                                        </div>

                                        <div class="info-item">
                                            <span class="info-label">Account Status</span>
                                            <span class="info-value">
                                                <%= isBlocked ? 'üîí Blocked' : '‚úÖ Active' %>
                                            </span>
                                        </div>
                                    </div>

                                    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <% if (!isBlocked && approvalStatus==='pending' ) { %>
                                            <form method="POST" action="/drivers/<%= driverId %>/approve"
                                                style="display: inline;">
                                                <button type="submit" class="btn-approve"
                                                    style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                                    ‚úÖ Approve Driver
                                                </button>
                                            </form>
                                            <form method="POST" action="/drivers/<%= driverId %>/reject"
                                                style="display: inline;"
                                                onsubmit="return confirm('Are you sure you want to reject this driver?')">
                                                <button type="submit" class="btn-reject"
                                                    style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                                    ‚ùå Reject Driver
                                                </button>
                                            </form>
                                            <% } %>

                                                <form method="POST"
                                                    action="/drivers/<%= driverId %>/<%= isBlocked ? 'unblock' : 'block' %>"
                                                    style="display: inline;">
                                                    <button type="submit" class="button ghost"
                                                        style="padding: 0.75rem 1.5rem;">
                                                        <%= isBlocked ? 'üîì Unblock Driver' : 'üîí Block Driver' %>
                                                    </button>
                                                </form>
                                    </div>
                                </div>

                                <!-- Document Status Section -->
                                <div class="document-section">
                                    <div class="section-header">
                                        <h2>üìÑ Documents</h2>
                                        <span style="color: #6b7280; font-size: 0.9rem;">
                                            <%= documents.length %> document<%= documents.length !==1 ? 's' : '' %>
                                        </span>
                                    </div>

                                    <% if (documents && documents.length> 0) { %>
                                        <table class="document-table">
                                            <thead>
                                                <tr>
                                                    <th>Document Name</th>
                                                    <th>Uploaded Date</th>
                                                    <th>Status</th>
                                                    <th>Preview</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% documents.forEach((doc)=> {
                                                    const docId = doc._id || doc.id;
                                                    const docName = doc.name || doc.type || doc.documentType ||
                                                    'Document';
                                                    const docStatus = doc.status || 'pending';
                                                    const uploadDate = doc.uploadedAt || doc.createdAt;
                                                    const docUrl = doc.url || doc.fileUrl || doc.documentUrl;

                                                    let docStatusClass = 'status-badge-pending';
                                                    let docStatusText = 'Pending';

                                                    if (docStatus === 'approved') {
                                                    docStatusClass = 'status-badge-approved';
                                                    docStatusText = 'Approved';
                                                    } else if (docStatus === 'rejected') {
                                                    docStatusClass = 'status-badge-rejected';
                                                    docStatusText = 'Rejected';
                                                    }
                                                    %>
                                                    <tr>
                                                        <td style="font-weight: 500;">
                                                            <%= docName %>
                                                        </td>
                                                        <td style="color: #6b7280; font-size: 0.85rem;">
                                                            <%= formatDate(uploadDate) %>
                                                        </td>
                                                        <td>
                                                            <span class="status-badge <%= docStatusClass %>">
                                                                <%= docStatusText %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <% if (docUrl) { %>
                                                                <button class="document-preview-btn"
                                                                    onclick="openDocumentModal('<%= docUrl %>', '<%= docName %>')">
                                                                    üëÅÔ∏è View
                                                                </button>
                                                                <% } else { %>
                                                                    <span style="color: #9ca3af; font-size: 0.85rem;">No
                                                                        file</span>
                                                                    <% } %>
                                                        </td>
                                                        <td>
                                                            <div class="document-actions">
                                                                <% if (docStatus==='pending' ) { %>
                                                                    <form method="POST"
                                                                        action="/drivers/<%= driverId %>/documents/<%= docId %>/approve"
                                                                        style="display: inline;">
                                                                        <button type="submit" class="btn-approve">
                                                                            ‚úÖ Approve
                                                                        </button>
                                                                    </form>
                                                                    <form method="POST"
                                                                        action="/drivers/<%= driverId %>/documents/<%= docId %>/reject"
                                                                        style="display: inline;">
                                                                        <button type="submit" class="btn-reject">
                                                                            ‚ùå Reject
                                                                        </button>
                                                                    </form>
                                                                    <% } else if (docStatus==='approved' ) { %>
                                                                        <span
                                                                            style="color: #16a34a; font-size: 0.85rem;">‚úì
                                                                            Approved</span>
                                                                        <% } else if (docStatus==='rejected' ) { %>
                                                                            <button class="btn-approve"
                                                                                style="font-size: 0.85rem;">
                                                                                üîÑ Request Reupload
                                                                            </button>
                                                                            <% } %>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                            </tbody>
                                        </table>
                                        <% } else { %>
                                            <div class="empty-state" style="padding: 2rem;">
                                                <div class="empty-state-icon" style="font-size: 3rem;">üìÑ</div>
                                                <h3>No documents uploaded</h3>
                                                <p>This driver hasn't uploaded any documents yet.</p>
                                            </div>
                                            <% } %>
                                </div>
                            </div>

                            <% } else { %>
                                <!-- Driver Not Found -->
                                <div class="empty-state" style="padding: 4rem 2rem;">
                                    <div class="empty-state-icon">‚ùå</div>
                                    <h3>Driver not found</h3>
                                    <p>The driver you're looking for doesn't exist or has been removed.</p>
                                    <a href="/drivers" class="button"
                                        style="margin-top: 1rem; padding: 0.75rem 1.5rem;">
                                        ‚Üê Back to Drivers
                                    </a>
                                </div>
                                <% } %>
            </main>
    </div>

    <!-- Document Preview Modal -->
    <div id="documentModal" class="modal-overlay" style="display: none;" onclick="closeDocumentModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeDocumentModal()">√ó</button>
            <h3 id="modalDocumentName" style="margin: 0 0 1.5rem 0; font-size: 1.25rem;">Document Preview</h3>
            <img id="modalDocumentImage" src="" alt="Document" class="document-preview-image" />
        </div>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        function openDocumentModal(url, name) {
            const modal = document.getElementById('documentModal');
            const image = document.getElementById('modalDocumentImage');
            const title = document.getElementById('modalDocumentName');

            image.src = url;
            title.textContent = name;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeDocumentModal() {
            const modal = document.getElementById('documentModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDocumentModal();
            }
        });
    </script>
</body>

</html>
